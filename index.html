
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a73e8">
<title>FIELD SALES PWA</title>
<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:15px}
.box{max-width:700px;margin:auto;background:#fff;padding:15px;border-radius:10px}
button{padding:12px;width:100%;margin-top:8px;border:none;border-radius:8px;font-weight:bold}
.blue{background:#1a73e8;color:#fff}
.green{background:#188038;color:#fff}
.red{background:#d93025;color:#fff}
.hidden{display:none}
input,select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc}
table{width:100%;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #ccc;padding:6px;text-align:center}
</style>
</head>

<body>
<div class="box">
<h3>LOGIN</h3>
<select id="user"></select>
<input id="pin" type="password" placeholder="PIN">
<button class="blue" onclick="login()">LOGIN</button>

<div id="menu" class="hidden">
<button onclick="show('cust')">ADD CUSTOMER</button>
<button onclick="show('sale')">SALES ORDER</button>
</div>

<div id="cust" class="hidden">
<h3>ADD CUSTOMER</h3>
<input id="cname" placeholder="CUSTOMER">
<input id="owner" placeholder="OWNER">
<input id="contact" placeholder="CONTACT">
<input id="sub" placeholder="SUBLOCALITY">
<button class="red" onclick="saveCustomer()">SAVE</button>
</div>

<div id="sale" class="hidden">
<h3>SALES ORDER</h3>
<input id="customer" placeholder="CUSTOMER">
<input id="recovery" placeholder="RECOVERY">
<table id="sku"><tbody></tbody></table>
<button class="green" onclick="saveOrder()">SAVE ORDER</button>
</div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzGLPzSlya9JWf8LJFuXVrTTw5TrIJbfkOa_1DsrnjXlQOWCotu2FST85CZx9IUxy0PjQ/exec";
const $=i=>document.getElementById(i);
let USER={};

// load users
fetch(API+"?action=getusers")
.then(r=>r.json())
.then(d=>{user.innerHTML="";
d.forEach(x=>user.innerHTML+=`<option data-pin="${x.pin}" data-area="${x.area}">${x.name}</option>`);});

function login(){
let o=user.selectedOptions[0];
if(pin.value!==o.dataset.pin){alert("WRONG PIN");return;}
USER.name=o.textContent;
menu.classList.remove("hidden");
loadProducts();
}

function show(id){cust.classList.add("hidden");sale.classList.add("hidden");$(id).classList.remove("hidden");}

function loadProducts(){
fetch(API+"?action=getproducts")
.then(r=>r.json())
.then(p=>{
let tb=sku.querySelector("tbody");tb.innerHTML="";
p.forEach(x=>tb.innerHTML+=`<tr><td>${x.sku}</td><td><input type='number'></td></tr>`);
});
}

function saveCustomer(){
let data={user:USER.name,customer:cname.value,owner:owner.value,contact:contact.value,sub:sub.value};
if(navigator.onLine){
fetch(API,{method:"POST",body:JSON.stringify({action:"saveCustomer",data})});
}else{
let a=JSON.parse(localStorage.getItem("CUSTQ")||"[]");
a.push(data);localStorage.setItem("CUSTQ",JSON.stringify(a));
}
cname.value=owner.value=contact.value=sub.value="";
alert("SAVED");
}

function saveOrder(){
let data={user:USER.name,customer:customer.value,recovery:recovery.value};
if(navigator.onLine){
fetch(API,{method:"POST",body:JSON.stringify({action:"saveSales",data})});
}else{
let a=JSON.parse(localStorage.getItem("ORDQ")||"[]");
a.push(data);localStorage.setItem("ORDQ",JSON.stringify(a));
}
customer.value=recovery.value="";
alert("ORDER SAVED");
}

// auto sync
window.addEventListener("online",()=>{
(JSON.parse(localStorage.getItem("CUSTQ")||"[]")).forEach(d=>fetch(API,{method:"POST",body:JSON.stringify({action:"saveCustomer",data:d})}));
(JSON.parse(localStorage.getItem("ORDQ")||"[]")).forEach(d=>fetch(API,{method:"POST",body:JSON.stringify({action:"saveSales",data:d})}));
localStorage.removeItem("CUSTQ");
localStorage.removeItem("ORDQ");
});

if("serviceWorker" in navigator){navigator.serviceWorker.register("sw.js");}
</script>
</body>
</html>
